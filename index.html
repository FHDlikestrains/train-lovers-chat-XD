<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ghaster Chat (Supabase)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
body { margin:0; background:#000; color:#fff; font-family:"Press Start 2P", monospace; }
.screen { display:flex; flex-direction:column; justify-content:center; align-items:center; height:100vh; text-align:center; }
#chatScreen { display:none; flex-direction:column; height:100vh; }
#chat { height:75vh; overflow-y:auto; padding:10px; width:90%; max-width:600px; border-bottom:2px solid #fff; }
#inputBar { display:flex; gap:10px; padding:10px; width:90%; max-width:600px; }
input, button { font-family:"Press Start 2P"; background:#111; border:1px solid #fff; color:#fff; padding:10px; }
.pfp { width:22px; height:22px; border-radius:50%; vertical-align:middle; margin-right:5px; }
#credits { font-size:10px; font-style:italic; text-align:center; margin-top:10px; }
</style>
</head>
<body>


<!-- Start Screen -->
<div id="startScreen" class="screen">
<h1>Ghaster Chat</h1>
<p><em>group chat made of some extremely unserious and unfunny individuals</em></p>
<button id="startBtn">Continue</button>
</div>


<!-- GC Pass Screen -->
<div id="passScreen" class="screen" style="display:none;">
<h2>Enter GC Pass</h2>
<input id="gcPassInput" type="password">
<button id="gcPassBtn">Enter</button>
</div>


<!-- Auth Screen -->
<div id="authScreen" class="screen" style="display:none;">
<h2>Sign Up / Login</h2>
<input id="authUsername" placeholder="Username">
<input id="authPassword" placeholder="Password" type="password">
<button id="signupBtn">Sign Up</button>
<button id="loginBtn">Login</button>
</div>


<!-- Chat Screen -->
<div id="chatScreen">
<div id="chat"></div>
<div id="inputBar">
<button id="pfpBtn">PFP</button>
<input type="file" id="pfpInput" style="display:none">
<button id="fileBtn">📎</button>
<input type="file" id="fileInput" style="display:none">
<input id="msgInput" placeholder="Message..." style="flex:1">
<button id="sendBtn">Send</button>
</div>
</div>


<div id="credits">Made by FHD & ChatGPT</div>


<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
document.addEventListener("DOMContentLoaded", async () => {
  // ---------- CONFIG ----------
  const SUPABASE_URL = "YOUR_URL"; // Replace
  const SUPABASE_ANON_KEY = "YOUR_ANON_KEY"; // Replace
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  
  const startScreen = document.getElementById("startScreen");
  const passScreen = document.getElementById("passScreen");
  const authScreen = document.getElementById("authScreen");
  const chatScreen = document.getElementById("chatScreen");
  const chat = document.getElementById("chat");
  
  let currentUser = null;
  let userPFP = null;
  const REAL_GC_PASS = "FHD likes uvor";


  // ---------- UTIL ----------
  function show(screen){
    [startScreen, passScreen, authScreen, chatScreen].forEach(s => s.style.display="none");
    screen.style.display = screen===chatScreen ? "flex" : "flex";
  }
  function addMessage(html){
    const div = document.createElement("div");
    div.className = "message";
    div.innerHTML = html;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }


  // ---------- START ----------
  document.getElementById("startBtn").onclick = () => show(passScreen);


  // ---------- GC PASS ----------
  document.getElementById("gcPassBtn").onclick = () => {
    if(gcPassInput.value === REAL_GC_PASS) show(authScreen);
    else alert("Wrong pass");
  };


  // ---------- SIGNUP ----------
  document.getElementById("signupBtn").onclick = async () => {
    const u = authUsername.value.trim();
    const p = authPassword.value.trim();
    if(!u||!p) return alert("Fill both fields");
    const { error } = await supabase.from("users").insert({ username:u, password:p });
    if(error) return alert("Username taken");
    currentUser = u;
    show(chatScreen);
    addMessage(`<em>${u} joined.</em>`);
    loadMessages();
  };


  // ---------- LOGIN ----------
  document.getElementById("loginBtn").onclick = async () => {
    const u = authUsername.value.trim();
    const p = authPassword.value.trim();
    if(!u||!p) return alert("Fill both fields");
    const { data } = await supabase.from("users").select().eq("username",u).eq("password",p).single();
    if(!data) return alert("Wrong info");
    currentUser = u;
    show(chatScreen);
    addMessage(`<em>${u} joined.</em>`);
    loadMessages();
  };


  // ---------- SEND MSG ----------
  document.getElementById("sendBtn").onclick = async () => {
    const msg = msgInput.value.trim();
    if(!msg) return;
    await supabase.from("messages").insert({ username:currentUser, text:msg, pfp:userPFP });
    msgInput.value="";
  };
  msgInput.addEventListener("keydown", e=>{if(e.key==="Enter") sendBtn.click();});


  // ---------- PFP ----------
  const pfpInput = document.getElementById("pfpInput");
  document.getElementById("pfpBtn").onclick = () => pfpInput.click();
  pfpInput.onchange = () => {
    const file = pfpInput.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => { userPFP = reader.result; alert("PFP set!"); };
    reader.readAsDataURL(file);
  };


  // ---------- FILE SHARE ----------
  const fileInput = document.getElementById("fileInput");
  document.getElementById("fileBtn").onclick = () => fileInput.click();
  fileInput.onchange = () => {
    const file = fileInput.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = async () => {
      await supabase.from("messages").insert({
        username:currentUser,
        text:`<a href='${reader.result}' download='${file.name}'>${file.name}</a>`,
        pfp:userPFP
      });
    };
    reader.readAsDataURL(file);
  };


  // ---------- LOAD MESSAGES ----------
  async function loadMessages(){
    const { data } = await supabase.from("messages").select().order("id");
    chat.innerHTML="";
    data.forEach(m=>{
      const pfpHTML = m.pfp?`<img class='pfp' src='${m.pfp}'>`:"";
      const msgText = m.text.replace(/@(\w+)/g,"<b>@$1</b>");
      addMessage(`${pfpHTML}<strong>${m.username}:</strong> ${msgText}`);
    });
  }


  // ---------- REALTIME ----------
  supabase.channel("messages")
    .on('postgres_changes',{ event:'*', schema:'public', table:'messages' }, payload => {
      const m = payload.new;
      const pfpHTML = m.pfp?`<img class='pfp' src='${m.pfp}'>`:"";
      const msgText = m.text.replace(/@(\w+)/g,"<b>@$1</b>");
      addMessage(`${pfpHTML}<strong>${m.username}:</strong> ${msgText}`);
    })
    .subscribe();


});
</script>
</body>
</html>