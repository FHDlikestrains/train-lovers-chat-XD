<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ghaster Chat (Supabase Fixed)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
  body { margin:0; background:#000; color:#fff; font-family:"Press Start 2P", monospace; }
  #startScreen, #passScreen, #authScreen {
    display:flex; flex-direction:column;
    justify-content:center; align-items:center;
    height:100vh; text-align:center;
  }
  #chatScreen { display:none; height:100vh; }
  #chat { height:75vh; overflow-y:auto; padding:10px; border-bottom:2px solid #fff; }
  .message { margin:10px 0; }
  #inputBar { display:flex; gap:10px; padding:10px; }
  input, button {
    font-family:"Press Start 2P";
    background:#111; border:1px solid #fff;
    color:#fff; padding:10px;
  }
  .pfp { width:22px; height:22px; border-radius:50%; vertical-align:middle; margin-right:5px; }
</style>
</head>
<body>

<!-- START SCREEN -->
<div id="startScreen">
  <h1>Ghaster Chat</h1>
  <p>group chat made of some extremely unserious and unfunny individuals</p>
  <button id="startBtn">Continue</button>
</div>

<!-- PASS SCREEN -->
<div id="passScreen" style="display:none;">
  <h2>Enter GC Pass</h2>
  <input id="gcPassInput" type="password" placeholder="Password">
  <button id="gcPassBtn">Enter</button>
</div>

<!-- AUTH SCREEN -->
<div id="authScreen" style="display:none;">
  <h2>Sign Up / Login</h2>
  <input id="authUsername" placeholder="Username">
  <input id="authPassword" type="password" placeholder="Password">
  <button id="signupBtn">Sign Up</button>
  <button id="authLoginBtn">Login</button>
</div>

<!-- CHAT SCREEN -->
<div id="chatScreen">
  <div id="chat"></div>

  <div id="inputBar">
    <button id="pfpBtn">PFP</button>
    <input type="file" id="pfpInput" style="display:none">

    <button id="fileBtn">ðŸ“Ž</button>
    <input type="file" id="fileInput" style="display:none">

    <input id="msgInput" placeholder="Message...">
    <button id="sendBtn">Send</button>
  </div>
</div>

<div style="text-align:center; padding:10px; font-size:10px; opacity:0.6; font-family:'Press Start 2P';">Made by FHD & ChatGPT</div>

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script>
// ---------------- CONFIG ----------------
// !!! REPLACE THESE WITH REAL VALUES !!!
const SUPABASE_URL = "REPLACE_URL";
const SUPABASE_ANON_KEY = "REPLACE_KEY";
const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUser = null;
let userPFP = null;

// ELEMENTS
const startScreen = document.getElementById("startScreen");
const passScreen = document.getElementById("passScreen");
const authScreen = document.getElementById("authScreen");
const chatScreen = document.getElementById("chatScreen");
const chat = document.getElementById("chat");

function show(screen){
  startScreen.style.display = "none";
  passScreen.style.display = "none";
  authScreen.style.display = "none";
  chatScreen.style.display = "none";
  screen.style.display = screen===chatScreen ? "block" : "flex";
}

// ---------------- START BUTTON ----------------
startBtn.onclick = () => show(passScreen);

// ---------------- PASS CHECK ----------------
gcPassBtn.onclick = async () => {
  const pass = gcPassInput.value;
  const { data } = await client.from("config").select().eq("key","gcPass").single();
  if (!data || data.value !== pass) return alert("Wrong pass");
  show(authScreen);
};

// ---------------- SIGN UP ----------------
signupBtn.onclick = async () => {
  const u = authUsername.value.trim();
  const p = authPassword.value.trim();
  if(!u || !p) return alert("Fill both fields");

  const { error } = await client.from("users").insert({ username:u, password:p });
  if(error) return alert("Username taken");

  currentUser = u;
  show(chatScreen);
  addMessage(`<em>${u} joined.</em>`);
  loadMessages();
};

// ---------------- LOGIN ----------------
authLoginBtn.onclick = async () => {
  const u = authUsername.value.trim();
  const p = authPassword.value.trim();
  if(!u || !p) return alert("Fill both fields");

  const { data } = await client.from("users").select().eq("username",u).eq("password",p).single();
  if(!data) return alert("Wrong info");

  currentUser = u;
  show(chatScreen);
  addMessage(`<em>${u} joined.</em>`);
  loadMessages();
};

// ---------------- ADD MESSAGE ----------------
function addMessage(html){
  const div = document.createElement("div");
  div.className = "message";
  div.innerHTML = html;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

// ---------------- SEND MSG ----------------
sendBtn.onclick = async () => {
  const msg = msgInput.value.trim();
  if(!msg) return;

  await client.from("messages").insert({ username:currentUser, text:msg, pfp:userPFP });
  msgInput.value = "";
};

// ---------------- REALTIME ----------------
client.channel("messages")
  .on('postgres_changes', { event:'*', schema:'public', table:'messages' }, payload => {
    const m = payload.new;
    const pfpHTML = m.pfp ? `<img class='pfp' src='${m.pfp}'>` : "";
    addMessage(`${pfpHTML}<strong>${m.username}:</strong> ${m.text}`);
  })
  .subscribe();

// ---------------- LOAD OLD MESSAGES ----------------
async function loadMessages(){
  const { data } = await client.from("messages").select().order("id");
  chat.innerHTML = "";
  data.forEach(m => {
    const pfpHTML = m.pfp ? `<img class='pfp' src='${m.pfp}'>` : "";
    addMessage(`${pfpHTML}<strong>${m.username}:</strong> ${m.text}`);
  });
}

// ---------------- PFP UPLOAD ----------------
pfpBtn.onclick = () => pfpInput.click();

pfpInput.onchange = async () => {
  const file = pfpInput.files[0];
  const reader = new FileReader();
  reader.onload = () => {
    userPFP = reader.result;
    alert("Profile picture set!");
  };
  reader.readAsDataURL(file);
};

// ---------------- FILE SHARING ----------------
fileBtn.onclick = () => fileInput.click();

fileInput.onchange = async () => {
  const file = fileInput.files[0];
  const reader = new FileReader();
  reader.onload = async () => {
    await client.from("messages").insert({
      username: currentUser,
      text: `<a href='${reader.result}' download='${file.name}'>${file.name}</a>`,
      pfp: userPFP
    });
  };
  reader.readAsDataURL(file);
};
</script>
</body>
</html>


